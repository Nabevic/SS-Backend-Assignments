
DATABASE NAME: psqlassignment

Tables:

CREATE TABLE IF NOT EXISTS Companies (
  company_id SERIAL PRIMARY KEY,
  company_name VARCHAR UNIQUE NOT NULL,
  active BOOLEAN
);

CREATE TABLE IF NOT EXISTS Products (
  product_id SERIAL PRIMARY KEY,
  product_name VARCHAR UNIQUE NOT NULL,
  company_id INTEGER,
  description VARCHAR,
  price REAL,
  active BOOLEAN,
  FOREIGN KEY (company_id)
    REFERENCES Companies(company_id)
);

CREATE TABLE IF NOT EXISTS Warranties (
  warranty_id SERIAL PRIMARY KEY,
  warranty_months INTEGER NOT NULL,
  product_id INTEGER,
  FOREIGN KEY (product_id)
    REFERENCES Products(product_id)
);

CREATE TABLE IF NOT EXISTS Categories (
  category_id SERIAL PRIMARY KEY,
  category_name VARCHAR UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS ProductsCategoriesXref (
  product_id INTEGER,
  category_id INTEGER,
  PRIMARY KEY (product_id, category_id),
  FOREIGN KEY (product_id)
    REFERENCES Products (product_id),
  FOREIGN KEY (category_id)
    REFERENCES Categories (category_id)
);


Create:

INSERT INTO Companies (
  company_name,
  active)
VALUES (
  'Test Company',
  TRUE
),
(
  'Toyz4Kidz',
  TRUE
);

INSERT INTO Categories (
  category_name
)
VALUES (
  'Prototypes'
),
(
  'Toys'
);

INSERT INTO Products (
  product_name,
  company_id,
  description,
  price,
  active
)
VALUES (
  'Rubix Cube',
  2,
  'Can you solve this infernal machine?',
  9.95,
  TRUE
),
 (
  'Prototype MK I',
  1,
  'First of its kind.',
  5.95,
  TRUE
),
 (
  'Prototype MK II',
  1,
  'Better than the last.',
  9.95,
  TRUE
),
 (
  'Prototype MK III',
  1,
  'Better than the last.',
  15.95,
  TRUE
),
 (
  'Kids Toy',
  2,
  'Your standard toy for kids.',
  19.95,
  TRUE
);

INSERT INTO Warranties (
  warranty_months,
  product_id
)
VALUES (
  6,
  1
);


INSERT INTO ProductsCategoriesXref (
  product_id,
  category_id
)
VALUES 
(1,2),
(2,1),
(3,1),
(4,1),
(5,2);


READ:

SELECT * FROM Companies;
SELECT * FROM Categories;
SELECT * FROM Products;
SELECT * FROM Warranties;
SELECT * FROM ProductsCategoriesXref;

SELECT * 
FROM Products
WHERE active = TRUE;

SELECT * 
FROM Products
WHERE company_id = 1;

SELECT *
FROM Companies
WHERE company_id = 1;

SELECT c.category_id, c.category_name, array_agg(p.product_name ORDER BY p.product_name) AS associated_products
FROM Categories c
JOIN ProductsCategoriesXref pcx
  ON pcx.category_id = c.category_id
JOIN Products p
  ON pcx.product_id = p.product_id
WHERE c.category_id = 1
GROUP BY c.category_id, c.category_name;

SELECT p.*, w.warranty_months, array_agg(c.category_name ORDER BY c.category_name) AS associated_categories
FROM Products p
INNER JOIN ProductsCategoriesXref pcx
  ON pcx.product_id = p.product_id
LEFT OUTER JOIN Categories c 
  ON pcx.category_id = c.category_id
LEFT OUTER JOIN Warranties w
  ON w.product_id = p.product_id
WHERE p.product_id = 1
GROUP BY p.product_id, w.warranty_months;

SELECT *
FROM Warranties
Where warranty_id = 1;



UPDATE:


UPDATE Companies
SET company_name = 'The Prototype Factory'
WHERE company_id = 1;

UPDATE Categories
SET category_name = 'Prototypes'
WHERE category_id = 1;

UPDATE Products
SET description = 'This needs an update', price = 24.95
WHERE product_id = 2;

UPDATE Warranties
SET warranty_months = 12
WHERE warranty_id = 1;

UPDATE ProductsCategoriesXref
SET category_id = 1
WHERE product_id = 3 AND category_id = 2; 


DELETE:

BEGIN;

DELETE FROM ProductsCategoriesXref
WHERE product_id = 1;

DELETE FROM Warranties
WHERE product_id = 1;

DELETE FROM Products
WHERE product_id = 1;

COMMIT;


BEGIN;

DELETE FROM ProductsCategoriesXref
WHERE category_id = 1;

DELETE FROM Categories
WHERE category_id = 1;

COMMIT;


BEGIN;

DELETE FROM ProductsCategoriesXref
USING Products
WHERE ProductsCategoriesXref.product_id = Products.product_id
  AND Products.company_id = 2;

DELETE FROM Products
WHERE company_id = 2;

DELETE FROM Companies
WHERE company_id = 2;

COMMIT;


DELETE FROM Warranties
WHERE warranty_id = 1;



